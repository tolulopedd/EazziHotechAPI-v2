generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
}

enum SubscriptionStatus {
  ACTIVE
  GRACE
  SUSPENDED
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum PropertyType {
  HOTEL
  SHORTLET
}

enum UnitType {
  ROOM
  APARTMENT
}

enum UnitDiscountType {
  PERCENT
  FIXED_PRICE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum PaymentMethod {
  MANUAL
  PAYSTACK
  STRIPE
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
  PARTIALLY_PAID
  UNPAID
}

enum BookingPaymentStatus {
  UNPAID
  PARTPAID
  PAID
  REFUNDED
}

enum BookingStayStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum CheckEventType {
  CHECK_IN
  CHECK_OUT
}

enum VerificationMode {
  MANUAL_REVIEW
  FACE_MATCH
}

enum VerificationResult {
  PENDING
  PASSED
  FAILED
}

/** ✅ NEW: charges for checkout blocking + damage/outstanding */
enum ChargeType {
  ROOM
  DAMAGE
  EXTRA
  PENALTY
  DISCOUNT
}

enum ChargeStatus {
  OPEN
  VOID
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  WON
  LOST
}

enum NewsType {
  ARTICLE
  VIDEO
  FEATURE
  ANNOUNCEMENT
}

enum NewsStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  status    TenantStatus @default(ACTIVE)
  subscriptionStatus       SubscriptionStatus @default(ACTIVE)
  currentPeriodEndAt       DateTime?
  graceEndsAt              DateTime?
  lastReminderSentAt       DateTime?
  lastSuspensionNoticeAt   DateTime?
  lastReactivationNoticeAt DateTime?

  email     String?
  phone     String?
  address   String?

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  users       User[]
  properties  Property[]
  units       Unit[]
  bookings    Booking[]
  payments    Payment[]
  checkEvents CheckEvent[]
  visitors    BookingVisitor[]
  settings    TenantSettings?

  /** ✅ NEW relations */
  guests      Guest[]
  charges     BookingCharge[]

  @@index([slug])
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String
  fullName     String?
  phone        String?
  passwordHash String
  role         UserRole @default(STAFF)
  assignedPropertyIds String[] @default([])

  status       UserStatus @default(ACTIVE)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, email], name: "tenantId_email")
  @@index([tenantId])
  @@index([tenantId, status])
}

model Property {
  id        String       @id @default(uuid())
  tenantId  String
  type      PropertyType @default(HOTEL)
  name      String
  address   String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  units  Unit[]

  @@index([tenantId])
  @@map("Hotel")
}

model Unit {
  id         String   @id @default(uuid())
  tenantId   String
  propertyId String
  type       UnitType
  name       String
  capacity   Int      @default(1)
  basePrice  Decimal? @db.Decimal(12, 2)
  discountType  UnitDiscountType?
  discountValue Decimal? @db.Decimal(12, 2)
  discountStart DateTime?
  discountEnd   DateTime?
  discountLabel String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  property Property  @relation(fields: [propertyId], references: [id])
  bookings Booking[]

  @@index([tenantId])
  @@index([propertyId])
}

model Booking {
  id        String  @id @default(uuid())
  tenantId  String
  unitId    String

  /** ✅ NEW: link to Guest master record */
  guestId   String?
  guest     Guest?  @relation(fields: [guestId], references: [id])

  status        BookingStayStatus     @default(PENDING)
  paymentStatus BookingPaymentStatus  @default(UNPAID)

  checkIn   DateTime
  checkOut  DateTime

  checkedInAt   DateTime?
  checkedOutAt  DateTime?
  checkInNotes  String?
  earlyCheckout Boolean @default(false)
  earlyCheckoutAt DateTime?
  refundPolicy String?
  refundEligibleAmount Decimal? @db.Decimal(12,2)
  refundApproved Boolean @default(false)
  refundAmount Decimal? @db.Decimal(12,2)
  refundStatus String?
  refundReason String?

  /**
   * ✅ Keep these as "snapshot" fields for audit/history.
   * You can gradually stop writing them later if you want, but keep them for now.
   */
  guestName        String?
  guestEmail       String?
  guestPhone       String?
  guestAddress     String?
  guestNationality String?

  totalAmount      Decimal? @db.Decimal(12,2)
  currency         String   @default("NGN")

  idType     String?
  idNumber   String?
  idIssuedBy String?

  vehiclePlate String?

  // ✅ Guest photo (for check-in verification)
  guestPhotoKey       String?
  guestPhotoMime      String?
  guestPhotoSize      Int?
  guestPhotoUpdatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  unit   Unit   @relation(fields: [unitId], references: [id])

  payments    Payment[]
  checkEvents CheckEvent[]
  visitors    BookingVisitor[]

  /** ✅ NEW: charges for room + damage + extras */
  charges     BookingCharge[]

  @@index([tenantId])
  @@index([unitId])
  @@index([tenantId, status])
  @@index([tenantId, guestId])
}

model BookingVisitor {
  id             String   @id @default(uuid())
  tenantId       String
  bookingId      String
  fullName       String
  phone          String?
  idType         String?
  idNumber       String?
  purpose        String?
  isOvernight    Boolean  @default(false)
  checkInAt      DateTime @default(now())
  checkOutAt     DateTime?
  notes          String?
  createdByUserId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([tenantId])
  @@index([bookingId])
  @@index([tenantId, bookingId, checkOutAt])
}

model Payment {
  id        String        @id @default(uuid())
  tenantId  String
  bookingId String

  method    PaymentMethod @default(MANUAL)
  status    PaymentStatus @default(PENDING)

  amount    Decimal       @db.Decimal(12, 2)
  currency  String        @default("NGN")
  reference String?
  notes     String?

  paidAt          DateTime?
  confirmedAt     DateTime?
  confirmedByUserId String?

  meta      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([tenantId])
  @@index([bookingId])
}

model BookingCharge {
  id        String   @id @default(uuid())
  tenantId  String
  bookingId String

  type      ChargeType
  title     String
  amount    Decimal  @db.Decimal(12, 2)
  currency  String   @default("NGN")
  status    ChargeStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([tenantId])
  @@index([bookingId])
  @@index([bookingId, type])
}

model CheckEvent {
  id        String            @id @default(uuid())
  tenantId  String
  bookingId String

  type      CheckEventType
  capturedAt DateTime         @default(now())
  capturedByUserId String?

  photoUrl  String?
  idDocUrl  String?

  verificationMode   VerificationMode   @default(MANUAL_REVIEW)
  verificationResult VerificationResult @default(PENDING)
  notes     String?
  earlyCheckout Boolean @default(false)
  refundPolicy String?
  refundEligibleAmount Decimal? @db.Decimal(12,2)
  refundApproved Boolean @default(false)
  refundAmount Decimal? @db.Decimal(12,2)
  refundStatus String?
  refundReason String?

  createdAt DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([tenantId])
  @@index([bookingId])
}

model TenantSettings {
  id        String   @id @default(uuid())
  tenantId  String   @unique

  minDepositPercent Int @default(100)

  maxProperties Int @default(5)
  maxUnits      Int @default(50)
  maxUsers      Int @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Guest {
  id        String   @id @default(uuid())
  tenantId  String

  fullName  String
  email     String?
  phone     String?
  address   String?
  nationality String?
  idType    String?
  idNumber  String?
  idIssuedBy String?

  vehiclePlate String?

  photoKey  String?
  photoMime String?
  photoSize Int?
  photoUpdatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  bookings Booking[]

  @@index([tenantId])
  @@index([tenantId, phone])
  @@index([tenantId, email])
  @@index([tenantId, idNumber])
}

model Lead {
  id          String     @id @default(uuid())
  companyName String
  contactName String
  email       String
  phone       String?
  businessType String?
  message     String?
  source      String?
  ip          String?
  status      LeadStatus @default(NEW)
  assignedTo  String?
  notes       String?
  contactedAt DateTime?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

model NewsItem {
  id            String     @id @default(uuid())
  title         String
  slug          String     @unique
  type          NewsType   @default(ARTICLE)
  status        NewsStatus @default(DRAFT)
  excerpt       String
  content       String?
  externalUrl   String?
  videoUrl      String?
  thumbnailUrl  String?
  isFeatured    Boolean    @default(false)
  publishedAt   DateTime?
  createdByUserId String?
  updatedByUserId String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([status, publishedAt])
  @@index([type, publishedAt])
  @@index([isFeatured, publishedAt])
}
